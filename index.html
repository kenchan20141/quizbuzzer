<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多設備線上搶答器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --secondary-dark: #16213e;
            --accent-blue: #0f3460;
            --accent-green: #2d5a27;
            --accent-gold: #8b7355;
            --text-light: #e5e7eb;
            --text-medium: #9ca3af;
            --danger: #7f1d1d;
        }

        body {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        .glass-button:active {
            transform: translateY(0);
        }

        .buzzer-container {
            perspective: 1000px;
        }

        .buzzer-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 
                0 0 20px rgba(255, 107, 107, 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            transform-style: preserve-3d;
        }

        .buzzer-button:hover {
            transform: translateY(-8px) rotateX(15deg);
            box-shadow: 
                0 20px 40px rgba(255, 107, 107, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .buzzer-button:active {
            transform: translateY(-4px) rotateX(10deg) scale(0.95);
            box-shadow: 
                0 10px 20px rgba(255, 107, 107, 0.5),
                inset 0 0 40px rgba(255, 255, 255, 0.3);
        }

        .buzzer-disabled {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            cursor: not-allowed;
            box-shadow: 
                0 0 10px rgba(74, 85, 104, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .buzzer-disabled:hover {
            transform: none;
            box-shadow: 
                0 0 10px rgba(74, 85, 104, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 3px solid rgba(255, 107, 107, 0.5);
            border-radius: 50%;
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
        }

        .winner-celebration {
            animation: celebration 1s ease-in-out;
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-2deg); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.05) rotate(2deg); }
        }

        .participant-item {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .participant-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .input-field::placeholder {
            color: var(--text-medium);
        }

        .status-indicator {
            position: relative;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -8px;
            width: 4px;
            height: 100%;
            background: linear-gradient(45deg, #10b981, #059669);
            border-radius: 2px;
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-bolt text-yellow-400 mr-3"></i>
                線上搶答器
            </h1>
    
        </header>

        <!-- 主選單 -->
        <div id="mainMenu" class="space-y-8">
            <div class="glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">選擇模式</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <button onclick="showCreateRoom()" class="glass-button p-8 rounded-2xl text-center group">
                        <div class="transform group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-crown text-5xl mb-4 text-yellow-400"></i>
                            <div class="text-xl font-semibold mb-2">創建房間</div>
                            <div class="text-sm text-gray-300">成為主持人</div>
                        </div>
                    </button>
                    <button onclick="showJoinRoom()" class="glass-button p-8 rounded-2xl text-center group">
                        <div class="transform group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-users text-5xl mb-4 text-green-400"></i>
                            <div class="text-xl font-semibold mb-2">加入房間</div>
                            <div class="text-sm text-gray-300">參與搶答</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- 創建房間 -->
        <div id="createRoomSection" class="hidden space-y-8">
            <div class="glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">
                    <i class="fas fa-crown text-yellow-400 mr-2"></i>
                    創建房間
                </h2>
                <div class="text-center space-y-6">
                    <p class="text-gray-300 text-lg">您將自動成為房間主持人</p>
                    <div class="flex gap-4 justify-center">
                        <button onclick="createRoom()" class="glass-button px-8 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-plus mr-2"></i>立即創建
                        </button>
                        <button onclick="showMainMenu()" class="glass-button px-8 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-arrow-left mr-2"></i>返回
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加入房間 -->
        <div id="joinRoomSection" class="hidden space-y-8">
            <div class="glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">
                    <i class="fas fa-sign-in-alt text-green-400 mr-2"></i>
                    加入房間
                </h2>
                <div class="max-w-md mx-auto space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">您的名稱</label>
                        <input type="text" id="playerName" class="input-field w-full px-4 py-3 rounded-xl" placeholder="輸入您的名稱">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">房間代碼</label>
                        <input type="text" id="roomCode" class="input-field w-full px-4 py-3 rounded-xl text-center text-2xl tracking-widest" placeholder="000000" maxlength="6">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="joinRoom()" class="glass-button flex-1 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-rocket mr-2"></i>加入
                        </button>
                        <button onclick="showMainMenu()" class="glass-button px-6 py-4 rounded-xl">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 遊戲畫面 -->
        <div id="gameSection" class="hidden space-y-8">
            <!-- 房間信息 -->
            <div class="glass-card p-6">
                <div class="flex justify-between items-center">
                    <div class="status-indicator">
                        <h3 class="text-xl font-semibold">房間 <span id="currentRoomCode" class="text-2xl font-mono text-green-400"></span></h3>
                        <p class="text-gray-300 mt-1">
                            <span id="currentPlayerName" class="font-medium"></span>
                            <span id="playerRole" class="ml-2 text-sm"></span>
                        </p>
                    </div>
                    <button onclick="leaveRoom()" class="glass-button px-6 py-3 rounded-xl text-red-300 hover:text-red-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>離開
                    </button>
                </div>
            </div>

            <!-- 搶答區域 -->
            <div class="glass-card p-8">
                <div id="waitingState" class="text-center">
                    <h3 class="text-2xl font-semibold mb-8">準備搶答</h3>
                    <div class="buzzer-container flex justify-center mb-8">
                        <div class="relative">
                            <div class="pulse-ring" id="pulseRing"></div>
                            <button id="buzzerButton" onclick="buzz()" class="buzzer-button">
                                <i class="fas fa-hand-paper"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-300 text-lg">點擊按鈕進行搶答</p>
                </div>
                
                <div id="resultState" class="hidden text-center">
                    <h3 class="text-2xl font-semibold mb-6">搶答結果</h3>
                    <div id="winnerInfo" class="glass-card p-6 mb-6 winner-celebration border-yellow-400 border-2">
                        <div class="text-3xl font-bold text-yellow-400 mb-2">
                            <i class="fas fa-trophy mr-3"></i>
                            <span id="winnerName"></span>
                        </div>
                        <div class="text-lg text-yellow-300">搶答成功！</div>
                        <div class="text-sm text-gray-300 mt-2">
                            時間: <span id="buzzerTime"></span>
                        </div>
                    </div>
                    <div id="hostControls" class="hidden">
                        <button onclick="resetBuzzer()" class="glass-button px-8 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-redo mr-2"></i>重新開始
                        </button>
                    </div>
                </div>
            </div>

            <!-- 參與者列表 -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-users mr-2"></i>
                    參與者 (<span id="participantCount">0</span>)
                </h3>
                <div id="participantsList" class="space-y-3">
                    <!-- 參與者將在這裡顯示 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAGSmNK1zBmXUM9aa81gCfb15sTA6rXsYE",
            authDomain: "quizbuzzer-64e02.firebaseapp.com",
            databaseURL: "https://quizbuzzer-64e02-default-rtdb.firebaseio.com",
            projectId: "quizbuzzer-64e02",
            storageBucket: "quizbuzzer-64e02.firebasestorage.app",
            messagingSenderId: "865117556536",
            appId: "1:865117556536:web:1bc501a4b5788f011b3bcd"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 全域變數
        let currentRoom = null;
        let currentPlayer = null;
        let isHost = false;
        let roomRef = null;

        // 創建浮動粒子效果
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // UI 控制函數
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('gameSection').classList.add('hidden');
        }

        function showCreateRoom() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('createRoomSection').classList.remove('hidden');
        }

        function showJoinRoom() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.remove('hidden');
        }

        function showGameSection() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
        }

        // 生成房間代碼
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // 創建房間
        async function createRoom() {
            try {
                const roomCode = generateRoomCode();
                const hostName = "主持人";
                
                const roomData = {
                    code: roomCode,
                    host: hostName,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    participants: {
                        [hostName]: {
                            name: hostName,
                            isHost: true,
                            joined: firebase.database.ServerValue.TIMESTAMP
                        }
                    },
                    buzzer: {
                        active: false,
                        winner: null,
                        timestamp: null
                    }
                };

                await database.ref('buzzer_rooms/' + roomCode).set(roomData);
                
                currentRoom = roomCode;
                currentPlayer = hostName;
                isHost = true;
                
                setupRoomListener();
                updateGameUI();
                showGameSection();
                
            } catch (error) {
                console.error('創建房間失敗:', error);
                alert('創建房間失敗，請重試');
            }
        }

        // 加入房間
        async function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!playerName || !roomCode) {
                alert('請輸入名稱和房間代碼');
                return;
            }

            if (roomCode.length !== 6) {
                alert('房間代碼必須是6位數');
                return;
            }

            try {
                const roomSnapshot = await database.ref('buzzer_rooms/' + roomCode).once('value');
                if (!roomSnapshot.exists()) {
                    alert('房間不存在');
                    return;
                }

                const roomData = roomSnapshot.val();
                if (roomData.participants && roomData.participants[playerName]) {
                    alert('此名稱已被使用，請選擇其他名稱');
                    return;
                }

                await database.ref('buzzer_rooms/' + roomCode + '/participants/' + playerName).set({
                    name: playerName,
                    isHost: false,
                    joined: firebase.database.ServerValue.TIMESTAMP
                });

                currentRoom = roomCode;
                currentPlayer = playerName;
                isHost = false;
                
                setupRoomListener();
                updateGameUI();
                showGameSection();
                
            } catch (error) {
                console.error('加入房間失敗:', error);
                alert('加入房間失敗，請重試');
            }
        }

        // 設置房間監聽器
        function setupRoomListener() {
            if (roomRef) {
                roomRef.off();
            }
            
            roomRef = database.ref('buzzer_rooms/' + currentRoom);
            roomRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    updateParticipantsList(roomData.participants);
                    updateBuzzerState(roomData.buzzer);
                } else {
                    alert('房間已不存在');
                    leaveRoom();
                }
            });
        }

        // 更新遊戲UI
        function updateGameUI() {
            document.getElementById('currentRoomCode').textContent = currentRoom;
            document.getElementById('currentPlayerName').textContent = currentPlayer;
            
            const roleElement = document.getElementById('playerRole');
            if (isHost) {
                roleElement.innerHTML = '<i class="fas fa-crown text-yellow-400"></i> 主持人';
                document.getElementById('hostControls').classList.remove('hidden');
                // 主持人不顯示搶答按鈕
                document.getElementById('waitingState').style.display = isHost ? 'none' : 'block';
            } else {
                roleElement.innerHTML = '<i class="fas fa-user text-green-400"></i> 參與者';
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('waitingState').style.display = 'block';
            }
        }

        // 更新參與者列表
        function updateParticipantsList(participants) {
            const listElement = document.getElementById('participantsList');
            const countElement = document.getElementById('participantCount');
            
            listElement.innerHTML = '';
            
            if (participants) {
                const participantArray = Object.values(participants);
                countElement.textContent = participantArray.length;
                
                participantArray.forEach(participant => {
                    const div = document.createElement('div');
                    div.className = 'participant-item flex items-center justify-between p-4 rounded-xl';
                    div.innerHTML = `
                        <div class="flex items-center">
                            ${participant.isHost ? 
                                '<i class="fas fa-crown text-yellow-400 mr-3 text-lg"></i>' : 
                                '<i class="fas fa-user text-green-400 mr-3"></i>'
                            }
                            <span class="font-medium text-lg">${participant.name}</span>
                        </div>
                        <span class="text-sm text-gray-400 px-3 py-1 rounded-full glass-button">
                            ${participant.isHost ? '主持人' : '參與者'}
                        </span>
                    `;
                    listElement.appendChild(div);
                });
            } else {
                countElement.textContent = '0';
            }
        }

        // 更新搶答狀態
        function updateBuzzerState(buzzerData) {
            const waitingState = document.getElementById('waitingState');
            const resultState = document.getElementById('resultState');
            const buzzerButton = document.getElementById('buzzerButton');
            const pulseRing = document.getElementById('pulseRing');
            
            if (buzzerData && buzzerData.active && buzzerData.winner) {
                // 有人搶答成功
                if (!isHost) {
                    waitingState.classList.add('hidden');
                }
                resultState.classList.remove('hidden');
                
                document.getElementById('winnerName').textContent = buzzerData.winner;
                document.getElementById('buzzerTime').textContent = new Date(buzzerData.timestamp).toLocaleTimeString();
                
                pulseRing.style.display = 'none';
                
            } else {
                // 等待搶答狀態
                if (!isHost) {
                    waitingState.classList.remove('hidden');
                    buzzerButton.classList.remove('buzzer-disabled');
                    buzzerButton.disabled = false;
                    pulseRing.style.display = 'block';
                }
                resultState.classList.add('hidden');
            }
        }

        // 搶答功能
        async function buzz() {
            if (!currentRoom || !currentPlayer || isHost) return;
            
            const buzzerButton = document.getElementById('buzzerButton');
            const pulseRing = document.getElementById('pulseRing');
            
            buzzerButton.classList.add('buzzer-disabled');
            buzzerButton.disabled = true;
            pulseRing.style.display = 'none';
            
            try {
                const buzzerRef = database.ref('buzzer_rooms/' + currentRoom + '/buzzer');
                const snapshot = await buzzerRef.once('value');
                const buzzerData = snapshot.val();
                
                // 檢查是否已有人搶答
                if (buzzerData && buzzerData.active && buzzerData.winner) {
                    return;
                }
                
                // 記錄搶答
                await buzzerRef.set({
                    active: true,
                    winner: currentPlayer,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
            } catch (error) {
                console.error('搶答失敗:', error);
                buzzerButton.classList.remove('buzzer-disabled');
                buzzerButton.disabled = false;
                pulseRing.style.display = 'block';
            }
        }

        // 重置搶答器（僅主持人可用）
        async function resetBuzzer() {
            if (!isHost || !currentRoom) return;
            
            try {
                await database.ref('buzzer_rooms/' + currentRoom + '/buzzer').set({
                    active: false,
                    winner: null,
                    timestamp: null
                });
            } catch (error) {
                console.error('重置失敗:', error);
                alert('重置失敗，請重試');
            }
        }

        // 離開房間
        async function leaveRoom() {
            if (roomRef) {
                roomRef.off();
                roomRef = null;
            }
            
            if (currentRoom && currentPlayer) {
                try {
                    await database.ref('buzzer_rooms/' + currentRoom + '/participants/' + currentPlayer).remove();
                    
                    // 如果是主持人離開，刪除整個房間
                    if (isHost) {
                        await database.ref('buzzer_rooms/' + currentRoom).remove();
                    }
                } catch (error) {
                    console.error('離開房間失敗:', error);
                }
            }
            
            currentRoom = null;
            currentPlayer = null;
            isHost = false;
            
            showMainMenu();
        }

        // 頁面離開時清理
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentPlayer) {
                database.ref('buzzer_rooms/' + currentRoom + '/participants/' + currentPlayer).remove();
            }
        });

        // 初始化頁面
        createParticles();
        showMainMenu();
    </script>
</body>
</html>
