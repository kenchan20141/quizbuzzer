<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多設備線上搶答器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js"></script>
    <style>
        .buzzer-button {
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .buzzer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .buzzer-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .pulse-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-bell text-yellow-600 mr-2"></i>
                線上搶答器
            </h1>
            <p class="text-gray-600">支援多設備的即時搶答系統</p>
        </header>

        <!-- 主選單 -->
        <div id="mainMenu" class="space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">選擇模式</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <button onclick="showCreateRoom()" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors">
                        <i class="fas fa-plus-circle text-2xl mb-2"></i>
                        <div class="text-lg font-semibold">創建房間</div>
                        <div class="text-sm opacity-90">成為主持人</div>
                    </button>
                    <button onclick="showJoinRoom()" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors">
                        <i class="fas fa-sign-in-alt text-2xl mb-2"></i>
                        <div class="text-lg font-semibold">加入房間</div>
                        <div class="text-sm opacity-90">參與搶答</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- 創建房間 -->
        <div id="createRoomSection" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">創建房間</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">您的名稱</label>
                        <input type="text" id="hostName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入主持人名稱">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="createRoom()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-plus mr-2"></i>創建房間
                        </button>
                        <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>返回
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加入房間 -->
        <div id="joinRoomSection" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">加入房間</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">您的名稱</label>
                        <input type="text" id="playerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="輸入您的名稱">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">房間代碼</label>
                        <input type="text" id="roomCode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="輸入6位數房間代碼">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="joinRoom()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>加入房間
                        </button>
                        <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>返回
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 遊戲畫面 -->
        <div id="gameSection" class="hidden space-y-6">
            <!-- 房間信息 -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">房間: <span id="currentRoomCode" class="text-blue-600"></span></h3>
                        <p class="text-sm text-gray-600">玩家: <span id="currentPlayerName" class="font-medium"></span></p>
                    </div>
                    <button onclick="leaveRoom()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-colors text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i>離開
                    </button>
                </div>
            </div>

            <!-- 搶答狀態 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div id="waitingState" class="text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">準備搶答</h3>
                    <button id="buzzerButton" onclick="buzz()" class="buzzer-button bg-yellow-500 hover:bg-yellow-600 text-white text-2xl font-bold py-12 px-16 rounded-full transition-all">
                        <i class="fas fa-bell text-4xl block mb-2"></i>
                        搶答
                    </button>
                </div>
                
                <div id="resultState" class="hidden text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">搶答結果</h3>
                    <div id="winnerInfo" class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 mb-4">
                        <div class="text-2xl font-bold text-yellow-800">
                            <i class="fas fa-trophy mr-2"></i>
                            <span id="winnerName"></span> 搶答成功！
                        </div>
                        <div class="text-sm text-yellow-700 mt-1">
                            時間: <span id="buzzerTime"></span>
                        </div>
                    </div>
                    <div id="hostControls" class="hidden space-x-3">
                        <button onclick="resetBuzzer()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-redo mr-2"></i>重新開始
                        </button>
                    </div>
                </div>
            </div>

            <!-- 參與者列表 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-users mr-2"></i>參與者
                </h3>
                <div id="participantsList" class="space-y-2">
                    <!-- 參與者將在這裡顯示 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAGSmNK1zBmXUM9aa81gCfb15sTA6rXsYE",
            authDomain: "quizbuzzer-64e02.firebaseapp.com",
            databaseURL: "https://quizbuzzer-64e02-default-rtdb.firebaseio.com",
            projectId: "quizbuzzer-64e02",
            storageBucket: "quizbuzzer-64e02.firebasestorage.app",
            messagingSenderId: "865117556536",
            appId: "1:865117556536:web:1bc501a4b5788f011b3bcd"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 全域變數
        let currentRoom = null;
        let currentPlayer = null;
        let isHost = false;
        let roomRef = null;

        // UI 控制函數
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('gameSection').classList.add('hidden');
        }

        function showCreateRoom() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('createRoomSection').classList.remove('hidden');
        }

        function showJoinRoom() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.remove('hidden');
        }

        function showGameSection() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
        }

        // 生成房間代碼
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // 創建房間
        async function createRoom() {
            const hostName = document.getElementById('hostName').value.trim();
            if (!hostName) {
                alert('請輸入主持人名稱');
                return;
            }

            try {
                const roomCode = generateRoomCode();
                const roomData = {
                    code: roomCode,
                    host: hostName,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    participants: {
                        [hostName]: {
                            name: hostName,
                            isHost: true,
                            joined: firebase.database.ServerValue.TIMESTAMP
                        }
                    },
                    buzzer: {
                        active: false,
                        winner: null,
                        timestamp: null
                    }
                };

                await database.ref('buzzer_rooms/' + roomCode).set(roomData);
                
                currentRoom = roomCode;
                currentPlayer = hostName;
                isHost = true;
                
                setupRoomListener();
                updateGameUI();
                showGameSection();
                
            } catch (error) {
                console.error('創建房間失敗:', error);
                alert('創建房間失敗，請重試');
            }
        }

        // 加入房間
        async function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!playerName || !roomCode) {
                alert('請輸入名稱和房間代碼');
                return;
            }

            if (roomCode.length !== 6) {
                alert('房間代碼必須是6位數');
                return;
            }

            try {
                const roomSnapshot = await database.ref('buzzer_rooms/' + roomCode).once('value');
                if (!roomSnapshot.exists()) {
                    alert('房間不存在');
                    return;
                }

                const roomData = roomSnapshot.val();
                if (roomData.participants && roomData.participants[playerName]) {
                    alert('此名稱已被使用，請選擇其他名稱');
                    return;
                }

                await database.ref('buzzer_rooms/' + roomCode + '/participants/' + playerName).set({
                    name: playerName,
                    isHost: false,
                    joined: firebase.database.ServerValue.TIMESTAMP
                });

                currentRoom = roomCode;
                currentPlayer = playerName;
                isHost = false;
                
                setupRoomListener();
                updateGameUI();
                showGameSection();
                
            } catch (error) {
                console.error('加入房間失敗:', error);
                alert('加入房間失敗，請重試');
            }
        }

        // 設置房間監聽器
        function setupRoomListener() {
            if (roomRef) {
                roomRef.off();
            }
            
            roomRef = database.ref('buzzer_rooms/' + currentRoom);
            roomRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    updateParticipantsList(roomData.participants);
                    updateBuzzerState(roomData.buzzer);
                } else {
                    alert('房間已不存在');
                    leaveRoom();
                }
            });
        }

        // 更新遊戲UI
        function updateGameUI() {
            document.getElementById('currentRoomCode').textContent = currentRoom;
            document.getElementById('currentPlayerName').textContent = currentPlayer;
            
            if (isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
            } else {
                document.getElementById('hostControls').classList.add('hidden');
            }
        }

        // 更新參與者列表
        function updateParticipantsList(participants) {
            const listElement = document.getElementById('participantsList');
            listElement.innerHTML = '';
            
            if (participants) {
                Object.values(participants).forEach(participant => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                    div.innerHTML = `
                        <span class="font-medium text-gray-800">
                            ${participant.isHost ? '<i class="fas fa-crown text-yellow-500 mr-1"></i>' : '<i class="fas fa-user text-gray-400 mr-1"></i>'}
                            ${participant.name}
                        </span>
                        <span class="text-xs text-gray-500">
                            ${participant.isHost ? '主持人' : '參與者'}
                        </span>
                    `;
                    listElement.appendChild(div);
                });
            }
        }

        // 更新搶答狀態
        function updateBuzzerState(buzzerData) {
            const waitingState = document.getElementById('waitingState');
            const resultState = document.getElementById('resultState');
            const buzzerButton = document.getElementById('buzzerButton');
            
            if (buzzerData && buzzerData.active && buzzerData.winner) {
                // 有人搶答成功
                waitingState.classList.add('hidden');
                resultState.classList.remove('hidden');
                
                document.getElementById('winnerName').textContent = buzzerData.winner;
                document.getElementById('buzzerTime').textContent = new Date(buzzerData.timestamp).toLocaleTimeString();
                
            } else {
                // 等待搶答狀態
                waitingState.classList.remove('hidden');
                resultState.classList.add('hidden');
                
                buzzerButton.classList.remove('disabled-button');
                buzzerButton.disabled = false;
            }
        }

        // 搶答功能
        async function buzz() {
            if (!currentRoom || !currentPlayer) return;
            
            const buzzerButton = document.getElementById('buzzerButton');
            buzzerButton.classList.add('disabled-button');
            buzzerButton.disabled = true;
            
            try {
                const buzzerRef = database.ref('buzzer_rooms/' + currentRoom + '/buzzer');
                const snapshot = await buzzerRef.once('value');
                const buzzerData = snapshot.val();
                
                // 檢查是否已有人搶答
                if (buzzerData && buzzerData.active && buzzerData.winner) {
                    return;
                }
                
                // 記錄搶答
                await buzzerRef.set({
                    active: true,
                    winner: currentPlayer,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
            } catch (error) {
                console.error('搶答失敗:', error);
                buzzerButton.classList.remove('disabled-button');
                buzzerButton.disabled = false;
            }
        }

        // 重置搶答器（僅主持人可用）
        async function resetBuzzer() {
            if (!isHost || !currentRoom) return;
            
            try {
                await database.ref('buzzer_rooms/' + currentRoom + '/buzzer').set({
                    active: false,
                    winner: null,
                    timestamp: null
                });
            } catch (error) {
                console.error('重置失敗:', error);
                alert('重置失敗，請重試');
            }
        }

        // 離開房間
        async function leaveRoom() {
            if (roomRef) {
                roomRef.off();
                roomRef = null;
            }
            
            if (currentRoom && currentPlayer) {
                try {
                    await database.ref('buzzer_rooms/' + currentRoom + '/participants/' + currentPlayer).remove();
                    
                    // 如果是主持人離開，刪除整個房間
                    if (isHost) {
                        await database.ref('buzzer_rooms/' + currentRoom).remove();
                    }
                } catch (error) {
                    console.error('離開房間失敗:', error);
                }
            }
            
            currentRoom = null;
            currentPlayer = null;
            isHost = false;
            
            showMainMenu();
        }

        // 頁面離開時清理
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentPlayer) {
                database.ref('buzzer_rooms/' + currentRoom + '/participants/' + currentPlayer).remove();
            }
        });

        // 初始化頁面
        showMainMenu();
    </script>
</body>
</html>
