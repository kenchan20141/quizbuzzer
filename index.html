<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè¨­å‚™ç·šä¸Šæ¶ç­”å™¨ - å‡ç´šç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --secondary-dark: #16213e;
            --accent-blue: #0f3460;
            --accent-green: #2d5a27;
            --accent-gold: #8b7355;
            --text-light: #e5e7eb;
            --text-medium: #9ca3af;
            --danger: #7f1d1d;
        }

        body {
            font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        .glass-button:active {
            transform: translateY(0);
        }

        .buzzer-container {
            perspective: 1000px;
        }

        .buzzer-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 
                0 0 20px rgba(255, 107, 107, 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            transform-style: preserve-3d;
        }

        .buzzer-button:hover {
            transform: translateY(-8px) rotateX(15deg);
            box-shadow: 
                0 20px 40px rgba(255, 107, 107, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .buzzer-button:active {
            transform: translateY(-4px) rotateX(10deg) scale(0.95);
            box-shadow: 
                0 10px 20px rgba(255, 107, 107, 0.5),
                inset 0 0 40px rgba(255, 255, 255, 0.3);
        }

        .buzzer-disabled {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            cursor: not-allowed;
            box-shadow: 
                0 0 10px rgba(74, 85, 104, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .buzzer-disabled:hover {
            transform: none;
            box-shadow: 
                0 0 10px rgba(74, 85, 104, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 3px solid rgba(255, 107, 107, 0.5);
            border-radius: 50%;
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
        }

        .winner-celebration {
            animation: celebration 1s ease-in-out;
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-2deg); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.05) rotate(2deg); }
        }

        .participant-item {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .participant-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .input-field::placeholder {
            color: var(--text-medium);
        }

        .status-indicator {
            position: relative;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -8px;
            width: 4px;
            height: 100%;
            background: linear-gradient(45deg, #10b981, #059669);
            border-radius: 2px;
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
        }

        .score-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .score-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .score-btn.plus {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
        }

        .score-btn.minus {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
        }

        .score-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .score-display {
            background: linear-gradient(145deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            min-width: 50px;
            text-align: center;
        }

        .qr-section {
            text-align: center;
            margin-top: 20px;
        }

        .qr-canvas {
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .copyright-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 5px 10px;
            background-color: #f1f1f1;
            color: #000000;
            z-index: 1000;
        }

        .copyright-footer p {
            margin: 0;
            font-size: 14px;
            color: #000000;
        }

        @media (max-width: 600px) {
            .copyright-footer p {
                font-size: 12px;
                color: #000000;
            }
        }
        
        @media print {
            .copyright-footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-bolt text-yellow-400 mr-3"></i>
                ç·šä¸Šæ¶ç­”å™¨ - å‡ç´šç‰ˆ
            </h1>
            <p class="text-gray-300">æ”¯æ´è¨ˆåˆ†åŠŸèƒ½èˆ‡QRç¢¼æˆ¿é–“åˆ†äº«</p>
        </header>

        <!-- ä¸»é¸å–® -->
        <div id="mainMenu" class="space-y-8">
            <div class="glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">é¸æ“‡æ¨¡å¼</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <button onclick="showCreateRoom()" class="glass-button p-8 rounded-2xl text-center group">
                        <div class="transform group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-crown text-5xl mb-4 text-yellow-400"></i>
                            <div class="text-xl font-semibold mb-2">å‰µå»ºæˆ¿é–“</div>
                            <div class="text-sm text-gray-300">æˆç‚ºä¸»æŒäººï¼Œç®¡ç†è¨ˆåˆ†</div>
                        </div>
                    </button>
                    <button onclick="showJoinRoom()" class="glass-button p-8 rounded-2xl text-center group">
                        <div class="transform group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-users text-5xl mb-4 text-green-400"></i>
                            <div class="text-xl font-semibold mb-2">åŠ å…¥æˆ¿é–“</div>
                            <div class="text-sm text-gray-300">åƒèˆ‡æ¶ç­”ï¼Œç²å¾—åˆ†æ•¸</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- å‰µå»ºæˆ¿é–“ -->
        <div id="createRoomSection" class="hidden space-y-8">
            <div class="glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">
                    <i class="fas fa-crown text-yellow-400 mr-2"></i>
                    å‰µå»ºæˆ¿é–“
                </h2>
                <div class="text-center space-y-6">
                    <p class="text-gray-300 text-lg">æ‚¨å°‡è‡ªå‹•æˆç‚ºæˆ¿é–“ä¸»æŒäººï¼Œå¯ä»¥ç®¡ç†åƒèˆ‡è€…è¨ˆåˆ†</p>
                    <div class="flex gap-4 justify-center">
                        <button onclick="createRoom()" class="glass-button px-8 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-plus mr-2"></i>ç«‹å³å‰µå»º
                        </button>
                        <button onclick="showMainMenu()" class="glass-button px-8 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-arrow-left mr-2"></i>è¿”å›
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ å…¥æˆ¿é–“ -->
        <div id="joinRoomSection" class="hidden space-y-8">
            <div class="glass-card p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">
                    <i class="fas fa-sign-in-alt text-green-400 mr-2"></i>
                    åŠ å…¥æˆ¿é–“
                </h2>
                <div class="max-w-md mx-auto space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">æ‚¨çš„åç¨±</label>
                        <input type="text" id="playerName" class="input-field w-full px-4 py-3 rounded-xl" placeholder="è¼¸å…¥æ‚¨çš„åç¨±">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">æˆ¿é–“ä»£ç¢¼</label>
                        <input type="text" id="roomCode" class="input-field w-full px-4 py-3 rounded-xl text-center text-2xl tracking-widest" placeholder="000000" maxlength="6">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="joinRoom()" class="glass-button flex-1 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-rocket mr-2"></i>åŠ å…¥
                        </button>
                        <button onclick="showMainMenu()" class="glass-button px-6 py-4 rounded-xl">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- éŠæˆ²ç•«é¢ -->
        <div id="gameSection" class="hidden space-y-8">
            <!-- æˆ¿é–“ä¿¡æ¯ -->
            <div class="glass-card p-6">
                <div class="flex justify-between items-center">
                    <div class="status-indicator">
                        <h3 class="text-xl font-semibold">æˆ¿é–“ <span id="currentRoomCode" class="text-2xl font-mono text-green-400"></span></h3>
                        <p class="text-gray-300 mt-1">
                            <span id="currentPlayerName" class="font-medium"></span>
                            <span id="playerRole" class="ml-2 text-sm"></span>
                        </p>
                    </div>
                    <button onclick="leaveRoom()" class="glass-button px-6 py-3 rounded-xl text-red-300 hover:text-red-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>é›¢é–‹
                    </button>
                </div>
            </div>

            <!-- QRç¢¼åˆ†äº«å€åŸŸ (åƒ…ä¸»æŒäººå¯è¦‹) -->
            <div id="qrSection" class="hidden glass-card p-6">
                <h3 class="text-xl font-semibold mb-4 text-center">
                    <i class="fas fa-qrcode text-blue-400 mr-2"></i>
                    æˆ¿é–“QRç¢¼
                </h3>
                <div class="qr-section">
                    <p class="text-gray-300 mb-4">åˆ†äº«æ­¤QRç¢¼è®“å…¶ä»–äººå¿«é€ŸåŠ å…¥æˆ¿é–“</p>
                    <canvas id="qrCanvas" class="qr-canvas"></canvas>
                    <p class="text-sm text-gray-400 mt-2">æƒæQRç¢¼å¾Œåªéœ€è¼¸å…¥åç¨±å³å¯åŠ å…¥</p>
                </div>
            </div>

            <!-- æ¶ç­”å€åŸŸ -->
            <div class="glass-card p-8">
                <div id="waitingState" class="text-center">
                    <h3 class="text-2xl font-semibold mb-8">æº–å‚™æ¶ç­”</h3>
                    <div class="buzzer-container flex justify-center mb-8">
                        <div class="relative">
                            <div class="pulse-ring" id="pulseRing"></div>
                            <button id="buzzerButton" onclick="buzz()" class="buzzer-button">
                                <i class="fas fa-hand-paper"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-300 text-lg">é»æ“ŠæŒ‰éˆ•é€²è¡Œæ¶ç­”</p>
                </div>
                
                <div id="resultState" class="hidden text-center">
                    <h3 class="text-2xl font-semibold mb-6">æ¶ç­”çµæœ</h3>
                    <div id="winnerInfo" class="glass-card p-6 mb-6 winner-celebration border-yellow-400 border-2">
                        <div class="text-3xl font-bold text-yellow-400 mb-2">
                            <i class="fas fa-trophy mr-3"></i>
                            <span id="winnerName"></span>
                        </div>
                        <div class="text-lg text-yellow-300">æ¶ç­”æˆåŠŸï¼</div>
                        <div class="text-sm text-gray-300 mt-2">
                            æ™‚é–“: <span id="buzzerTime"></span>
                        </div>
                    </div>
                    <div id="hostControls" class="hidden space-y-4">
                        <div class="flex gap-4 justify-center">
                            <button onclick="awardPoint()" class="glass-button px-6 py-3 rounded-xl font-semibold text-green-400">
                                <i class="fas fa-plus mr-2"></i>ç­”å° (+1åˆ†)
                            </button>
                            <button onclick="deductPoint()" class="glass-button px-6 py-3 rounded-xl font-semibold text-red-400">
                                <i class="fas fa-minus mr-2"></i>ç­”éŒ¯ (-1åˆ†)
                            </button>
                        </div>
                        <button onclick="resetBuzzer()" class="glass-button px-8 py-4 rounded-xl font-semibold text-lg">
                            <i class="fas fa-redo mr-2"></i>é‡æ–°é–‹å§‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- åƒèˆ‡è€…åˆ—è¡¨èˆ‡è¨ˆåˆ†æ¿ -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">
                    <i class="fas fa-trophy mr-2"></i>
                    è¨ˆåˆ†æ¿ (<span id="participantCount">0</span>)
                </h3>
                <div id="participantsList" class="space-y-3">
                    <!-- åƒèˆ‡è€…å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAGSmNK1zBmXUM9aa81gCfb15sTA6rXsYE",
            authDomain: "quizbuzzer-64e02.firebaseapp.com",
            databaseURL: "https://quizbuzzer-64e02-default-rtdb.firebaseio.com",
            projectId: "quizbuzzer-64e02",
            storageBucket: "quizbuzzer-64e02.firebasestorage.app",
            messagingSenderId: "865117556536",
            appId: "1:865117556536:web:1bc501a4b5788f011b3bcd"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // å…¨åŸŸè®Šæ•¸
        let currentRoom = null;
        let currentPlayer = null;
        let isHost = false;
        let roomRef = null;
        let currentWinner = null;

        // éœ‡å‹•åé¥‹å‡½æ•¸
        function triggerVibration(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // å‰µå»ºæµ®å‹•ç²’å­æ•ˆæœ
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // æª¢æŸ¥URLåƒæ•¸
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                document.getElementById('roomCode').value = roomCode;
                showJoinRoom();
            }
        }

        // ç”ŸæˆQRç¢¼
        function generateQRCode(roomCode) {
            const canvas = document.getElementById('qrCanvas');
            const url = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            
            QRCode.toCanvas(canvas, url, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) {
                    console.error('QRç¢¼ç”Ÿæˆå¤±æ•—:', error);
                } else {
                    document.getElementById('qrSection').classList.remove('hidden');
                }
            });
        }

        // UI æ§åˆ¶å‡½æ•¸
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('gameSection').classList.add('hidden');
        }

        function showCreateRoom() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('createRoomSection').classList.remove('hidden');
        }

        function showJoinRoom() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.remove('hidden');
        }

        function showGameSection() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('joinRoomSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
        }

        // ç”Ÿæˆæˆ¿é–“ä»£ç¢¼
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // å‰µå»ºæˆ¿é–“
        async function createRoom() {
            try {
                const roomCode = generateRoomCode();
                const hostName = "ä¸»æŒäºº";
                
                const roomData = {
                    code: roomCode,
                    host: hostName,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    participants: {
                        [hostName]: {
                            name: hostName,
                            isHost: true,
                            joined: firebase.database.ServerValue.TIMESTAMP
                        }
                    },
                    buzzer: {
                        active: false,
                        winner: null,
                        timestamp: null
                    }
                };

                await database.ref('buzzer_rooms/' + roomCode).set(roomData);
                
                currentRoom = roomCode;
                currentPlayer = hostName;
                isHost = true;
                
                setupRoomListener();
                updateGameUI();
                generateQRCode(roomCode);
                showGameSection();
                
            } catch (error) {
                console.error('å‰µå»ºæˆ¿é–“å¤±æ•—:', error);
                alert('å‰µå»ºæˆ¿é–“å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // åŠ å…¥æˆ¿é–“
        async function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!playerName || !roomCode) {
                alert('è«‹è¼¸å…¥åç¨±å’Œæˆ¿é–“ä»£ç¢¼');
                return;
            }

            if (roomCode.length !== 6) {
                alert('æˆ¿é–“ä»£ç¢¼å¿…é ˆæ˜¯6ä½æ•¸');
                return;
            }

            try {
                const roomSnapshot = await database.ref('buzzer_rooms/' + roomCode).once('value');
                if (!roomSnapshot.exists()) {
                    alert('æˆ¿é–“ä¸å­˜åœ¨');
                    return;
                }

                const roomData = roomSnapshot.val();
                if (roomData.participants && roomData.participants[playerName]) {
                    alert('æ­¤åç¨±å·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–åç¨±');
                    return;
                }

                await database.ref('buzzer_rooms/' + roomCode + '/participants/' + playerName).set({
                    name: playerName,
                    isHost: false,
                    joined: firebase.database.ServerValue.TIMESTAMP,
                    score: 0
                });

                currentRoom = roomCode;
                currentPlayer = playerName;
                isHost = false;
                
                setupRoomListener();
                updateGameUI();
                showGameSection();
                
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é–“å¤±æ•—:', error);
                alert('åŠ å…¥æˆ¿é–“å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // è¨­ç½®æˆ¿é–“ç›£è½å™¨
        function setupRoomListener() {
            if (roomRef) {
                roomRef.off();
            }
            
            roomRef = database.ref('buzzer_rooms/' + currentRoom);
            roomRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    updateParticipantsList(roomData.participants);
                    updateBuzzerState(roomData.buzzer);
                } else {
                    alert('æˆ¿é–“å·²ä¸å­˜åœ¨');
                    leaveRoom();
                }
            });
        }

        // æ›´æ–°éŠæˆ²UI
        function updateGameUI() {
            document.getElementById('currentRoomCode').textContent = currentRoom;
            document.getElementById('currentPlayerName').textContent = currentPlayer;
            
            const roleElement = document.getElementById('playerRole');
            if (isHost) {
                roleElement.innerHTML = '<i class="fas fa-crown text-yellow-400"></i> ä¸»æŒäºº';
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('waitingState').style.display = 'none';
                document.getElementById('qrSection').classList.remove('hidden');
            } else {
                roleElement.innerHTML = '<i class="fas fa-user text-green-400"></i> åƒèˆ‡è€…';
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('waitingState').style.display = 'block';
                document.getElementById('qrSection').classList.add('hidden');
            }
        }

        // æ›´æ–°åƒèˆ‡è€…åˆ—è¡¨
        function updateParticipantsList(participants) {
            const listElement = document.getElementById('participantsList');
            const countElement = document.getElementById('participantCount');
            
            listElement.innerHTML = '';
            
            if (participants) {
                const participantArray = Object.values(participants);
                const playerCount = participantArray.filter(p => !p.isHost).length;
                countElement.textContent = playerCount;
                
                // æŒ‰åˆ†æ•¸æ’åºï¼ˆä¸»æŒäººé™¤å¤–ï¼‰
                const sortedParticipants = participantArray.sort((a, b) => {
                    if (a.isHost) return -1;
                    if (b.isHost) return 1;
                    return (b.score || 0) - (a.score || 0);
                });
                
                sortedParticipants.forEach((participant, index) => {
                    const div = document.createElement('div');
                    div.className = 'participant-item flex items-center justify-between p-4 rounded-xl';
                    
                    if (participant.isHost) {
                        div.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-crown text-yellow-400 mr-3 text-lg"></i>
                                <span class="font-medium text-lg">${participant.name}</span>
                            </div>
                            <span class="text-sm text-gray-400 px-3 py-1 rounded-full glass-button">
                                ä¸»æŒäºº
                            </span>
                        `;
                    } else {
                        const rank = index; // ä¸»æŒäººæ’ç¬¬ä¸€ï¼Œæ‰€ä»¥åƒèˆ‡è€…å¾indexé–‹å§‹å°±æ˜¯æ’å
                        let rankIcon = '';
                        if (rank === 1) rankIcon = 'ğŸ¥‡';
                        else if (rank === 2) rankIcon = 'ğŸ¥ˆ';
                        else if (rank === 3) rankIcon = 'ğŸ¥‰';
                        else rankIcon = `#${rank}`;
                        
                        div.innerHTML = `
                            <div class="flex items-center">
                                <span class="text-lg mr-3 min-w-8">${rankIcon}</span>
                                <span class="font-medium text-lg">${participant.name}</span>
                            </div>
                            <div class="flex items-center">
                                <div class="score-display mr-3">${participant.score || 0}</div>
                                ${isHost ? `
                                    <div class="score-controls">
                                        <button class="score-btn minus" onclick="adjustScore('${participant.name}', -1)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <button class="score-btn plus" onclick="adjustScore('${participant.name}', 1)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    listElement.appendChild(div);
                });
            } else {
                countElement.textContent = '0';
            }
        }

        // èª¿æ•´åˆ†æ•¸
        async function adjustScore(playerName, change) {
            if (!isHost || !currentRoom) return;
            
            try {
                const participantRef = database.ref('buzzer_rooms/' + currentRoom + '/participants/' + playerName);
                const snapshot = await participantRef.once('value');
                const participantData = snapshot.val();
                
                if (participantData && !participantData.isHost) {
                    const newScore = Math.max(0, (participantData.score || 0) + change);
                    await participantRef.update({ score: newScore });
                    
                    triggerVibration(50);
                }
            } catch (error) {
                console.error('èª¿æ•´åˆ†æ•¸å¤±æ•—:', error);
            }
        }

        // æ›´æ–°æ¶ç­”ç‹€æ…‹
        function updateBuzzerState(buzzerData) {
            const waitingState = document.getElementById('waitingState');
            const resultState = document.getElementById('resultState');
            const buzzerButton = document.getElementById('buzzerButton');
            const pulseRing = document.getElementById('pulseRing');
            
            if (buzzerData && buzzerData.active && buzzerData.winner) {
                currentWinner = buzzerData.winner;
                
                if (!isHost) {
                    waitingState.classList.add('hidden');
                    if (buzzerData.winner !== currentPlayer) {
                        triggerVibration([100, 50, 100]);
                    }
                }
                resultState.classList.remove('hidden');
                
                document.getElementById('winnerName').textContent = buzzerData.winner;
                document.getElementById('buzzerTime').textContent = new Date(buzzerData.timestamp).toLocaleTimeString();
                
                pulseRing.style.display = 'none';
                
            } else {
                currentWinner = null;
                
                if (!isHost) {
                    waitingState.classList.remove('hidden');
                    buzzerButton.classList.remove('buzzer-disabled');
                    buzzerButton.disabled = false;
                    pulseRing.style.display = 'block';
                }
                resultState.classList.add('hidden');
            }
        }

        // æ¶ç­”åŠŸèƒ½
        async function buzz() {
            if (!currentRoom || !currentPlayer || isHost) return;
            
            const buzzerButton = document.getElementById('buzzerButton');
            const pulseRing = document.getElementById('pulseRing');
            
            triggerVibration(50);
            
            buzzerButton.classList.add('buzzer-disabled');
            buzzerButton.disabled = true;
            pulseRing.style.display = 'none';
            
            try {
                const buzzerRef = database.ref('buzzer_rooms/' + currentRoom + '/buzzer');
                const snapshot = await buzzerRef.once('value');
                const buzzerData = snapshot.val();
                
                if (buzzerData && buzzerData.active && buzzerData.winner) {
                    triggerVibration([100, 50, 100]);
                    return;
                }
                
                await buzzerRef.set({
                    active: true,
                    winner: currentPlayer,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                triggerVibration([200, 100, 200, 100, 200]);
                
            } catch (error) {
                console.error('æ¶ç­”å¤±æ•—:', error);
                triggerVibration([50, 25, 50, 25, 50]);
                buzzerButton.classList.remove('buzzer-disabled');
                buzzerButton.disabled = false;
                pulseRing.style.display = 'block';
            }
        }

        // ç­”å°åŠ åˆ†
        async function awardPoint() {
            if (currentWinner) {
                await adjustScore(currentWinner, 1);
                await resetBuzzer();
            }
        }

        // ç­”éŒ¯æ‰£åˆ†
        async function deductPoint() {
            if (currentWinner) {
                await adjustScore(currentWinner, -1);
                await resetBuzzer();
            }
        }

        // é‡ç½®æ¶ç­”å™¨
        async function resetBuzzer() {
            if (!isHost || !currentRoom) return;
            
            try {
                await database.ref('buzzer_rooms/' + currentRoom + '/buzzer').set({
                    active: false,
                    winner: null,
                    timestamp: null
                });
                
                triggerVibration(100);
                
            } catch (error) {
                console.error('é‡ç½®å¤±æ•—:', error);
                alert('é‡ç½®å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // é›¢é–‹æˆ¿é–“
        async function leaveRoom() {
            if (roomRef) {
                roomRef.off();
                roomRef = null;
            }
            
            if (currentRoom && currentPlayer) {
                try {
                    await database.ref('buzzer_rooms/' + currentRoom + '/participants/' + currentPlayer).remove();
                    
                    if (isHost) {
                        await database.ref('buzzer_rooms/' + currentRoom).remove();
                    }
                } catch (error) {
                    console.error('é›¢é–‹æˆ¿é–“å¤±æ•—:', error);
                }
            }
            
            currentRoom = null;
            currentPlayer = null;
            isHost = false;
            currentWinner = null;
            
            showMainMenu();
        }

        // é é¢é›¢é–‹æ™‚æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentPlayer) {
                database.ref('buzzer_rooms/' + currentRoom + '/participants/' + currentPlayer).remove();
            }
        });

        // åˆå§‹åŒ–é é¢
        createParticles();
        checkUrlParams();
        showMainMenu();
    </script>

    <footer class="copyright-footer">
        <p>Copyright Â© 2025 é™³å† å¥. All rights reserved.</p>
    </footer>
    
</body>
</html>
